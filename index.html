<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Share My Sight - è¦–è¦šã‚µãƒãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* ===== åŸºæœ¬è¨­å®š (å®‰å®šç‰ˆ) ===== */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0;
    padding: 0;
    background-color: #ece9e6;
    font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
    color: #333;
    -webkit-font-smoothing: antialiased;
    line-height: 1.6;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }

  .container-app {
    width: 100%;
    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚è¦‹ã‚„ã™ã„ã‚ˆã†å¹…ã‚’åºƒã‚ã«ç¢ºä¿ */
    max-width: 600px;
    height: 100vh;
    background: #f7efe3;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 25px rgba(0,0,0,0.15);
  }

  /* ç”»é¢ã”ã¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .screen {
    display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 24px;
    padding-bottom: 120px; /* ãƒŠãƒ“ãƒãƒ¼åˆ† */
    background: #f7efe3;
    flex-direction: column;
    width: 100%;
    height: 100%;
  }

  /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç”»é¢ã ã‘è¡¨ç¤º */
  .screen.active {
    display: flex;
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ãƒãƒƒãƒãƒ³ã‚°ç”»é¢å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ & ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ */
  #matchScreen.active {
    display: flex;
    flex-direction: column;
    overflow: hidden; /* ç”»é¢å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
    padding-bottom: 100px;
  }

  h1 { text-align: center; font-size: 24px; font-weight: bold; margin: 20px 0; color: #444; flex-shrink: 0; }

  /* ===== ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ ===== */
  .nav {
    display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
    position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
    border-top: 1px solid rgba(0,0,0,0.05); justify-content: space-evenly;
    align-items: center; padding-bottom: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
    z-index: 100;
  }
  .nav.active { display: flex; }

  .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 20%; cursor: pointer; color: #888; transition: transform 0.1s; }
  .nav-icon { font-size: 24px; margin-bottom: 2px; }
  .nav-label { font-size: 10px; font-weight: bold; }
  .nav-item:active { transform: scale(0.9); }
  .nav-item.active { color: #ff6b81; }

  /* ===== ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ===== */
  .input-group { margin-bottom: 24px; text-align: center; width: 100%; }
  .input-label { display: block; font-size: 18px; font-weight: bold; margin-bottom: 12px; color: #555; }
  .text-input { width: 100%; padding: 16px; font-size: 18px; border: 2px solid #ddd; border-radius: 16px; outline: none; text-align: center; background: white; }
  .text-input:focus { border-color: #ff6b81; }

  .primary-btn {
    width: 100%; padding: 18px; font-size: 18px; font-weight: bold; color: white;
    background: #ff6b81; border: none; border-radius: 20px; cursor: pointer;
    box-shadow: 0 4px 10px rgba(255, 107, 129, 0.4); transition: transform 0.1s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .primary-btn:active { transform: scale(0.98); }
  .primary-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; opacity: 0.6; pointer-events: none; }

  .role-btn {
    width: 100%; padding: 24px; margin-bottom: 20px; background: white; border: 2px solid #ffdde3;
    border-radius: 20px; text-align: left; cursor: pointer; display: flex; align-items: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  }
  .role-btn:active { transform: scale(0.98); background: #fff0f3; }
  .role-btn-icon { font-size: 32px; margin-right: 16px; width: 50px; text-align: center; }
  .role-btn-title { font-size: 18px; font-weight: bold; color: #ff6b81; display: block; }
  .role-btn-desc { font-size: 14px; color: #555; }

  .hobby-grid { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 30px; }
  .hobby-choice { padding: 12px 20px; background: white; border: 2px solid #ffdde3; border-radius: 30px; font-size: 16px; color: #555; cursor: pointer; }
  .hobby-choice.selected { background: #ff6b81; color: white; border-color: #ff6b81; box-shadow: 0 4px 8px rgba(255, 107, 129, 0.3); }

  /* ===== ãƒªã‚¹ãƒˆè¡¨ç¤º (æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¿®æ­£ç‰ˆ) ===== */
  .match-header-text {
    text-align: center; color: #444; font-size: 16px; font-weight: bold;
    margin-bottom: 10px; background: #e6f0ff; padding: 10px; border-radius: 10px;
    flex-shrink: 0;
  }
  
  /* ã‚«ãƒ¼ãƒ‰ãŒè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
  .match-scroll-area {
    display: flex; 
    gap: 20px; 
    overflow-x: auto; 
    overflow-y: hidden; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
    padding: 20px 20px 50px 20px; /* ä¸‹éƒ¨ä½™ç™½ã‚’ç¢ºä¿ã—ã¦å½±ã‚’è¡¨ç¤º */
    scroll-snap-type: x mandatory; 
    -webkit-overflow-scrolling: touch;
    width: 100%;
    align-items: center; /* å‚ç›´æ–¹å‘ä¸­å¤®é…ç½® */
    flex: 1;
  }
  .match-scroll-area::-webkit-scrollbar { display: none; }

  .match-card {
    background: white; border-radius: 24px; padding: 16px; 
    box-shadow: 0 10px 20px rgba(0,0,0,0.08); cursor: pointer;
    display: flex; flex-direction: column; align-items: center; text-align: center;
    border: 2px solid transparent; position: relative; flex-shrink: 0;
  }
  .match-card.best-match { border-color: #ff6b81; background: #fff5f7; }
  .match-card:active { transform: scale(0.98); }
  
  /* ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºèª¿æ•´ï¼šé«˜ã•åˆ¶é™ã‚’å¤–ã—ã€å†…å®¹ã«åˆã‚ã›ã¦ä¼¸ç¸®ã•ã›ã‚‹ */
  .match-scroll-area .match-card { 
    width: 280px; 
    height: auto; 
    min-height: 400px;
    scroll-snap-align: center; 
    margin-bottom: 0; 
  }
  
  .favorite-list .match-card { width: 100%; height: auto; flex-direction: row; padding: 16px; text-align: left; border: 2px solid #eee; margin-bottom: 16px; }

  .card-img-placeholder {
    width: 100%; height: 180px; border-radius: 20px;
    background: linear-gradient(135deg, #cce7ff 0%, #eaf6ff 100%);
    display: flex; align-items: center; justify-content: center; font-size: 50px; margin-bottom: 12px;
  }
  .favorite-list .card-img-placeholder { width: 80px; height: 80px; font-size: 36px; margin-right: 16px; border-radius: 16px; flex-shrink: 0; }
  
  .match-badge {
    position: absolute; top: 10px; right: 10px; background: #ff6b81;
    color: white; font-size: 12px; font-weight: bold; padding: 4px 8px;
    border-radius: 10px; z-index: 10;
  }
  .tag {
    display: inline-block; padding: 6px 16px; background: #ffdde3;
    color: #ff5c7c; border-radius: 20px; font-size: 13px; font-weight: bold; margin-top: auto;
  }
  .favorite-list .tag { margin-top: 8px; padding: 4px 12px; font-size: 12px; }
  .favorite-info { flex: 1; }

  /* ===== (å¾©å…ƒ) ãƒªãƒƒãƒãªãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ ===== */
  /* è©³ç´°ç”»é¢ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å…¨ç”»é¢ä»•æ§˜ã« */
  #detailScreen {
    padding: 0; 
  }
  .detail-screen-wrapper {
    background: #fdfbf7;
    min-height: 100%;
    padding-bottom: 100px;
  }

  /* ã‚«ãƒãƒ¼ç”»åƒ */
  .profile-cover {
    height: 180px;
    background: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%);
    position: relative;
  }
  
  /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
  .detail-back-overlay {
    position: absolute; top: 20px; left: 20px; width: 44px; height: 44px;
    background: rgba(255,255,255,0.9); border-radius: 50%; display: flex;
    align-items: center; justify-content: center; font-size: 24px; color: #333;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer; z-index: 10; border: none;
  }

  /* ã‚¢ã‚¤ã‚³ãƒ³ */
  .profile-avatar-wrapper {
    width: 130px; height: 130px; border-radius: 50%; background: white;
    position: absolute; bottom: -65px; left: 50%; transform: translateX(-50%);
    display: flex; align-items: center; justify-content: center; font-size: 70px;
    border: 5px solid white; box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  }

  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ± */
  .profile-info-area {
    margin-top: 75px; text-align: center; padding: 0 24px;
  }
  .profile-main-name { font-size: 30px; font-weight: 800; color: #1a1a1a; line-height: 1.2; margin-bottom: 4px; }
  .profile-meta-row {
    display: flex; justify-content: center; align-items: center; gap: 12px;
    color: #666; font-size: 15px; margin-bottom: 20px;
  }

  /* çµ±è¨ˆæƒ…å ±ï¼ˆStatsï¼‰ */
  .profile-stats-card {
    display: flex; justify-content: space-around; padding: 20px; background: white;
    border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 24px;
    border: 1px solid #f0f0f0;
  }
  .stat-item { text-align: center; }
  .stat-val { font-size: 20px; font-weight: 800; color: #333; }
  .stat-label { font-size: 11px; font-weight: bold; color: #999; margin-top: 2px; }

  /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .content-section { text-align: left; margin-bottom: 24px; }
  .section-label {
    font-size: 15px; font-weight: 800; color: #333; margin-bottom: 12px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-label::before { content: ''; display: block; width: 4px; height: 18px; background: #0066cc; border-radius: 2px; }
  
  .bio-text {
    font-size: 16px; line-height: 1.8; color: #444; background: white;
    padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    border: 1px solid #f0f0f0;
  }

  .tags-wrapper { display: flex; flex-wrap: wrap; gap: 10px; }
  .skill-tag { background: #e6f0ff; color: #0066cc; padding: 8px 16px; border-radius: 30px; font-size: 14px; font-weight: bold; }
  .hobby-tag { background: #f5f5f5; color: #555; padding: 8px 16px; border-radius: 30px; font-size: 14px; font-weight: bold; }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
  .profile-fixed-footer {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
    padding: 16px 24px 30px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    z-index: 100; border-top: 1px solid #eee;
  }
  .action-main-btn {
    width: 100%; padding: 18px; border-radius: 18px; font-size: 18px; font-weight: bold;
    text-align: center; border: none; cursor: pointer; transition: transform 0.1s;
    box-shadow: 0 5px 15px rgba(0, 102, 204, 0.2);
  }
  .action-main-btn:active { transform: scale(0.98); }
  .btn-connect { background: #0066cc; color: white; }
  .btn-connected { background: white; border: 3px solid #0066cc; color: #0066cc; }

  /* ===== ãƒãƒ£ãƒƒãƒˆé–¢é€£ ===== */
  .chat-list-item {
    display: flex; align-items: center; padding: 16px; background: white;
    border-radius: 20px; margin-bottom: 12px; cursor: pointer;
    transition: background 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .chat-list-item:active { background: #f0f0f0; }
  .chat-list-icon {
    width: 50px; height: 50px; border-radius: 50%; background: #eaf6ff;
    display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 16px;
  }
  .chat-list-content { flex: 1; }
  .chat-list-name { font-weight: bold; font-size: 16px; color: #333; }
  .chat-list-msg { color: #888; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ  */
  .chat-room-header {
    background: #fff; padding: 16px; position: sticky; top: 0; z-index: 50;
    display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 1px solid #eee;
  }
  .chat-back-btn { font-size: 28px; color: #ff6b81; background: none; border: none; cursor: pointer; padding: 10px 20px 10px 0; font-weight: bold; }
  #chatTargetName { font-size: 18px; }

  .chat-messages { padding-bottom: 140px; }
  .message-bubble {
    max-width: 70%; padding: 12px 16px; border-radius: 18px; font-size: 15px;
    line-height: 1.5; margin-bottom: 12px; position: relative;
  }
  .msg-received { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-right: auto; }
  .msg-sent { align-self: flex-end; background: #ff6b81; color: white; border-bottom-right-radius: 4px; box-shadow: 0 2px 5px rgba(255,107,129,0.3); margin-left: auto; }
  
  .chat-footer-area {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 90; padding-bottom: 10px;
  }
  .chat-action-bar { display: flex; padding: 8px 16px; background: #fff0f3; gap: 8px; overflow-x: auto; }
  .action-btn {
    background: white; border: 1px solid #ff6b81; color: #ff6b81; padding: 6px 12px;
    border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; white-space: nowrap;
  }
  .action-btn-complete { background: #ff6b81; color: white; }
  .chat-input-bar { padding: 10px 16px; display: flex; gap: 10px; }
  .chat-input { flex: 1; background: #f0f0f0; border: none; border-radius: 24px; padding: 12px; outline: none; }
  .chat-send-btn { background: #ff6b81; color: white; border: none; width: 44px; height: 44px; border-radius: 50%; font-size: 20px; cursor: pointer; }

  .plan-card {
    background: white; border: 2px solid #ff6b81; border-radius: 16px; padding: 0;
    overflow: hidden; margin-top: 5px; width: 100%; max-width: 280px;
  }
  .plan-header { background: #ff6b81; color: white; padding: 8px 12px; font-weight: bold; font-size: 14px; }
  .plan-body { padding: 12px; font-size: 15px; color: #333; }
  .plan-row { margin-bottom: 8px; }
  .plan-label { font-size: 12px; color: #666; font-weight: bold; }
  .plan-value { font-weight: bold; font-size: 16px; }

  /* ===== ãƒ¬ãƒ“ãƒ¥ãƒ¼ & ãƒã‚¤ãƒšãƒ¼ã‚¸ & ã‚·ãƒ§ãƒƒãƒ— & ãƒ¡ãƒ¼ãƒ« ===== */
  .review-container, .mypage-container {
    text-align: center; padding: 20px; background: white; border-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  .review-avatar {
    width: 80px; height: 80px; background: #eee; border-radius: 50%; margin: 0 auto 16px;
    display: flex; align-items: center; justify-content: center; font-size: 40px; border: 2px solid #ddd;
  }
  .star { font-size: 44px; color: #ddd; cursor: pointer; }
  .star.active { color: #ffd700; }
  .review-textarea {
    width: 100%; padding: 16px; border: 2px solid #ccc; border-radius: 16px;
    font-size: 16px; min-height: 100px; margin-bottom: 20px;
  }
  .coin-section { margin: 20px 0; padding: 16px; background: #fff9e6; border-radius: 16px; border: 2px solid #ffe066; }
  .coin-title { font-weight: bold; color: #b38f00; margin-bottom: 12px; font-size: 18px; }
  .coin-options { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
  .coin-btn {
    padding: 8px 16px; border: 2px solid #ffd700; background: white; border-radius: 20px;
    color: #b38f00; cursor: pointer; min-width: 60px;
  }
  .coin-btn.active { background: #ffd700; color: white; }
  .coin-display { font-size: 28px; font-weight: bold; color: #e6ac00; }

  #shopScreen .grid-container {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding-bottom: 80px;
  }
  .mail-item {
    background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; gap: 12px; align-items: flex-start;
  }
  .mail-icon { font-size: 24px; }
  .mail-content { flex: 1; }
  .mail-title { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
  .mail-body { font-size: 13px; color: #666; line-height: 1.5; }
  .mail-time { font-size: 12px; color: #999; margin-top: 8px; text-align: right; }

  /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ ===== */
  .header-icons { position: absolute; top: 20px; right: 20px; z-index: 110; }
  .mailbox-btn {
    font-size: 24px; background: white; border-radius: 50%; width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; position: relative;
  }
  .notification-badge {
    position: absolute; top: -2px; right: -2px; background: #ff4757; color: white;
    font-size: 10px; width: 18px; height: 18px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
  }

  /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
  .modal-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 2000;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }
  .modal-content {
    background: white; width: 90%; max-width: 360px; border-radius: 20px;
    padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  .modal-title { font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 20px; }
  .modal-form-group { margin-bottom: 16px; }
  .modal-label { display: block; font-weight: bold; margin-bottom: 6px; color: #444; }
  .modal-input {
    width: 100%; padding: 12px; border: 2px solid #ccc; border-radius: 12px;
    font-size: 16px; background: #f9f9f9;
  }
  .modal-input:focus { border-color: #0066cc; outline: none; }
  .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
  .modal-btn { flex: 1; padding: 14px; border-radius: 16px; font-weight: bold; font-size: 16px; cursor: pointer; border: none; }
  .modal-btn-cancel { background: #eee; color: #444; }
  .modal-btn-submit { background: #0066cc; color: white; }

  /* ãƒˆãƒ¼ã‚¹ãƒˆ */
  .toast {
    position: absolute; top: 20px; left: 0; right: 0; margin: 0 auto;
    width: fit-content; max-width: 90%;
    background: #333; color: white; padding: 12px 20px; border-radius: 30px;
    font-size: 14px; font-weight: bold; z-index: 3000; opacity: 0; transition: all 0.4s;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

</style>
</head>

<body>

<div id="toast" class="toast">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>

<!-- ãƒ—ãƒ©ãƒ³ç›¸è«‡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="planModal" class="modal-overlay">
  <div class="modal-content">
    <h2 class="modal-title">ã‚µãƒãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ã®ç›¸è«‡</h2>
    <div class="modal-form-group">
      <label class="modal-label">é›†åˆæ—¥æ™‚</label>
      <input type="datetime-local" id="planDate" class="modal-input">
    </div>
    <div class="modal-form-group">
      <label class="modal-label">é›†åˆå ´æ‰€</label>
      <input type="text" id="planPlace" class="modal-input" placeholder="ä¾‹ï¼šæ±äº¬é§… ä¸¸ã®å†…åŒ—å£">
    </div>
    <div class="modal-form-group">
      <label class="modal-label">å†…å®¹</label>
      <input type="text" id="planTodo" class="modal-input" placeholder="ä¾‹ï¼šè²·ã„ç‰©åŒè¡Œ">
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-cancel" onclick="app.closePlanModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn modal-btn-submit" onclick="app.submitPlan()">ææ¡ˆã™ã‚‹</button>
    </div>
  </div>
</div>

<div class="container-app">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ -->
  <div id="headerIcons" class="header-icons hidden">
    <div class="mailbox-btn" onclick="app.openMailbox()">
      ğŸ“¬
      <div id="mailBadge" class="notification-badge hidden">!</div>
    </div>
  </div>

  <!-- 1. åå‰å…¥åŠ›ç”»é¢ -->
  <div id="welcomeScreen" class="screen active">
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
      <h1>Share My Sight<br><span style="font-size:16px; font-weight:normal;">è¦–è¦šã‚µãƒãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°</span></h1>
      <p style="text-align:center; color:#444; margin-bottom:40px;">ã‚ãªãŸã®ã€Œè¦‹ãŸã„ã€ã‚’<br>æ‰‹åŠ©ã‘ã™ã‚‹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’æ¢ã—ã¾ã—ã‚‡ã†</p>
      <div class="input-group">
        <label class="input-label">ãŠåå‰ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰</label>
        <input type="text" id="userNameInput" class="text-input" placeholder="ä¾‹ï¼šãƒ¤ãƒãƒ€" oninput="app.checkNameInput()">
      </div>
      <button id="toHobbyBtn" class="primary-btn" onclick="app.goToRoleSelection()" disabled>æ¬¡ã¸é€²ã‚€</button>
    </div>
  </div>

  <!-- 1.5. ãƒ­ãƒ¼ãƒ«é¸æŠç”»é¢ -->
  <div id="roleScreen" class="screen">
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
      <h1>åˆ©ç”¨æ–¹æ³•ã®é¸æŠ</h1>
      <p style="text-align:center; color:#444; margin-bottom:30px;">ã©ã¡ã‚‰ã¨ã—ã¦åˆ©ç”¨ã—ã¾ã™ã‹ï¼Ÿ</p>
      <button class="role-btn" onclick="app.selectRole('requester')">
        <div class="role-btn-icon">ğŸ‘¨â€ğŸ¦¯</div>
        <div class="role-btn-text">
          <span class="role-btn-title">ã‚µãƒãƒ¼ãƒˆã‚’å¸Œæœ›ã™ã‚‹</span>
          <span class="role-btn-desc">è¦–è¦šã‚µãƒãƒ¼ãƒˆãƒ»åŒè¡Œæ´è­·ã‚’æ¢ã™</span>
        </div>
      </button>
      <button class="role-btn" onclick="app.selectRole('supporter')">
        <div class="role-btn-icon">ğŸ¤</div>
        <div class="role-btn-text">
          <span class="role-btn-title">ã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã™ã‚‹</span>
          <span class="role-btn-desc">ãŠæ‰‹ä¼ã„ãŒå¿…è¦ãªæ–¹ã‚’æ¢ã™</span>
        </div>
      </button>
      <button style="margin-top:20px; background:none; border:none; color:#666; text-decoration:underline;" onclick="app.backToWelcome()">æˆ»ã‚‹</button>
    </div>
  </div>

  <!-- 2. è¶£å‘³é¸æŠç”»é¢ -->
  <div id="hobbyScreen" class="screen">
    <h1 id="hobbyTitle">ã“ã‚“ã«ã¡ã¯ï¼</h1>
    <p style="text-align:center; color:#666; margin-bottom:30px;">å…±é€šã®è©±é¡ŒãŒã‚ã‚‹ã‚µãƒãƒ¼ã‚¿ãƒ¼ã‚’æ¢ã—ã¾ã™ã€‚<br>èˆˆå‘³ã®ã‚ã‚‹ã“ã¨ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
    <div id="hobbyGrid" class="hobby-grid"></div>
    <div style="margin-top:auto;">
      <button id="toMatchBtn" class="primary-btn" onclick="app.goToMatchScreen()" disabled>ã‚µãƒãƒ¼ã‚¿ãƒ¼ã‚’æ¢ã™</button>
      <button style="width:100%; margin-top:16px; background:none; border:none; color:#666; padding:10px;" onclick="app.backToRoleSelection()">æˆ»ã‚‹</button>
    </div>
  </div>

  <!-- 3. ãƒãƒƒãƒãƒ³ã‚°ç”»é¢ (ä¿®æ­£: ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹åŒ–ã€ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºèª¿æ•´) -->
  <div id="matchScreen" class="screen">
    <h1 id="matchScreenTitle" style="margin-top:20px;">Share My Sight</h1>
    <div class="match-header-text" id="matchHeaderText">ãŠã™ã™ã‚ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼</div>
    <!-- æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
    <div id="matchGrid" class="match-scroll-area"></div>
    <div style="padding:20px; text-align:center; color:#666; font-size:14px; flex-shrink:0;">
      <p id="matchFooterText">â€» æ°—ã«ãªã‚‹ã‚µãƒãƒ¼ã‚¿ãƒ¼ã‚’é¸ã‚“ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
    </div>
  </div>

  <!-- 4. ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆç”»é¢ -->
  <div id="favoriteScreen" class="screen">
    <h1>ãƒªã‚¹ãƒˆ</h1>
    <p style="text-align:center; color:#666; margin-bottom:20px;" id="favSubTitle">æ°—ã«ãªã£ã¦ã„ã‚‹äºº</p>
    <div id="favoriteGrid" class="favorite-list"></div>
  </div>

  <!-- 5. ãƒãƒ£ãƒƒãƒˆä¸€è¦§ç”»é¢ -->
  <div id="chatListScreen" class="screen">
    <h1>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h1>
    <div id="chatListContainer"></div>
  </div>

  <!-- 6. ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ç”»é¢ -->
  <div id="chatRoomScreen" class="screen" style="padding:0; padding-bottom:0;">
    <div class="chat-room-header">
      <button class="chat-back-btn" onclick="app.backToChatList()">â€¹</button>
      <div style="font-weight:bold; font-size:18px;" id="chatTargetName">ç›¸æ‰‹ã®åå‰</div>
    </div>
    <div id="chatMessageArea" class="chat-messages" style="flex:1; overflow-y:auto; padding:20px;"></div>
    
    <div class="chat-footer-area">
      <div class="chat-action-bar">
        <button class="action-btn" onclick="app.openPlanModal()">ğŸ“… ãƒ—ãƒ©ãƒ³ç›¸è«‡</button>
        <button id="completeBtn" class="action-btn action-btn-complete" onclick="app.openReview()">âœ… å®Œäº†ãƒ»è©•ä¾¡</button>
      </div>
      <div class="chat-input-bar">
        <input type="text" id="chatInput" class="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...">
        <button class="chat-send-btn" onclick="app.sendMessage()">â¤</button>
      </div>
    </div>
  </div>

  <!-- 7. è©³ç´°ç”»é¢ (ãƒªãƒƒãƒãƒ‡ã‚¶ã‚¤ãƒ³) -->
  <div id="detailScreen" class="screen" style="padding:0;">
    <div class="detail-screen-wrapper" id="detailContent">
      <!-- JSã§ç”Ÿæˆ -->
    </div>
  </div>

  <!-- 8. è©•ä¾¡ç”»é¢ -->
  <div id="reviewScreen" class="screen">
    <h1>ã‚µãƒãƒ¼ãƒˆã®è©•ä¾¡</h1>
    <p style="text-align:center; color:#666; margin-bottom:20px;">ä»Šå›ã®ã‚µãƒãƒ¼ãƒˆã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ</p>
    <div class="review-container">
      <div id="reviewTargetIcon" class="review-avatar">ğŸ‘¤</div>
      <h2 id="reviewTargetName" style="margin-bottom:20px;">Aã•ã‚“</h2>
      <div id="starRating" class="star-rating">
        <span class="star" onclick="app.setRating(1)">â˜…</span>
        <span class="star" onclick="app.setRating(2)">â˜…</span>
        <span class="star" onclick="app.setRating(3)">â˜…</span>
        <span class="star" onclick="app.setRating(4)">â˜…</span>
        <span class="star" onclick="app.setRating(5)">â˜…</span>
      </div>
      <div id="ratingText" style="text-align:center; font-weight:bold; color:#ff6b81; margin-bottom:20px;">è©•ä¾¡ã‚’é¸æŠ</div>
      
      <div class="coin-section">
        <div class="coin-title">ğŸª™ æ„Ÿè¬ã®ã‚³ã‚¤ãƒ³ã‚’è´ˆã‚‹</div>
        <div class="coin-options">
          <button class="coin-btn" onclick="app.setCoin(0)">ãªã—</button>
          <button class="coin-btn" onclick="app.setCoin(100)">100</button>
          <button class="coin-btn" onclick="app.setCoin(300)">300</button>
          <button class="coin-btn" onclick="app.setCoin(500)">500</button>
        </div>
        <div id="coinAmountDisplay" class="coin-display" style="text-align:center;">0 æš</div>
      </div>

      <textarea id="reviewComment" class="review-textarea" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ..."></textarea>
      <button class="primary-btn" onclick="app.submitReview()">è©•ä¾¡ã‚’é€ä¿¡</button>
      <button style="margin-top:20px; background:none; border:none; text-decoration:underline; color:#666;" onclick="app.cancelReview()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- 9. ã‚·ãƒ§ãƒƒãƒ—ç”»é¢ -->
  <div id="shopScreen" class="screen">
    <h1>ãƒã‚¤ãƒ³ãƒˆäº¤æ›</h1>
    <div style="background:#fff9e6; border:2px solid #ffe066; border-radius:16px; padding:20px; text-align:center; margin-bottom:24px;">
      <div style="font-size:14px; color:#b38f00;">ç¾åœ¨ã®ä¿æœ‰ã‚³ã‚¤ãƒ³</div>
      <div style="font-size:32px; font-weight:bold; color:#e6ac00;"><span id="shopCoinDisplay">0</span> <span style="font-size:16px;">æš</span></div>
    </div>
    <div class="grid-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding-bottom:80px;">
      <div style="background:white; padding:16px; border-radius:16px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <div style="font-size:40px;">â˜•</div>
        <div style="font-weight:bold; margin:8px 0;">ã‚«ãƒ•ã‚§ãƒã‚±ãƒƒãƒˆ</div>
        <div style="color:#e6ac00; font-weight:bold;">500 æš</div>
        <button class="primary-btn" style="padding:8px; font-size:12px; margin-top:8px;" onclick="app.exchangeItem(500, 'ã‚«ãƒ•ã‚§ãƒã‚±ãƒƒãƒˆ')">äº¤æ›</button>
      </div>
      <div style="background:white; padding:16px; border-radius:16px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <div style="font-size:40px;">ğŸ«</div>
        <div style="font-weight:bold; margin:8px 0;">æ˜ ç”»ã‚¯ãƒ¼ãƒãƒ³</div>
        <div style="color:#e6ac00; font-weight:bold;">1000 æš</div>
        <button class="primary-btn" style="padding:8px; font-size:12px; margin-top:8px;" onclick="app.exchangeItem(1000, 'æ˜ ç”»ã‚¯ãƒ¼ãƒãƒ³')">äº¤æ›</button>
      </div>
    </div>
  </div>

  <!-- 10. ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ç”»é¢ -->
  <div id="mailboxScreen" class="screen">
    <h1>å—ä¿¡ç®±</h1>
    <div id="mailboxList" class="mailbox-list"></div>
    <button class="primary-btn" style="margin-top:20px; background:#999;" onclick="app.closeMailbox()">é–‰ã˜ã‚‹</button>
  </div>

  <!-- 11. ãƒã‚¤ãƒšãƒ¼ã‚¸ç”»é¢ -->
  <div id="myPageScreen" class="screen">
    <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
    <div class="mypage-container">
      <div style="width:100px; height:100px; background:#eaf6ff; border-radius:50%; margin:0 auto 16px; display:flex; align-items:center; justify-content:center; font-size:50px;">ğŸ‘¤</div>
      <h2 id="myPageName" style="margin-bottom:8px;">ã‚²ã‚¹ãƒˆ</h2>
      <div style="display:inline-block; padding:4px 12px; background:#eee; border-radius:12px; font-size:12px; color:#555;" id="myPageRole">æœªè¨­å®š</div>
      
      <div style="display:flex; justify-content:center; margin-top:20px; gap:20px;">
        <div>
          <div style="font-size:12px; color:#888;">ä¿æœ‰ã‚³ã‚¤ãƒ³</div>
          <div style="font-size:20px; font-weight:bold; color:#e6ac00;"><span id="myPageCoin">0</span> æš</div>
        </div>
        <div style="border-left:1px solid #ddd;"></div>
        <div>
          <div style="font-size:12px; color:#888;">èˆˆå‘³</div>
          <div style="font-size:16px; font-weight:bold;" id="myPageHobby">-</div>
        </div>
      </div>
    </div>
    <button class="primary-btn" style="margin-top:24px; background:#fff; color:#333; border:2px solid #ccc;" onclick="app.showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'); app.backToWelcome();">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
  <nav id="navBar" class="nav">
    <div class="nav-item" id="navShop" onclick="app.goToShop()">
      <span class="nav-icon">ğŸ</span>
      <span class="nav-label">ã‚·ãƒ§ãƒƒãƒ—</span>
    </div>
    <div class="nav-item active" id="navSearch" onclick="app.goToMatchScreen()">
      <span class="nav-icon">ğŸ”</span>
      <span class="nav-label">ã•ãŒã™</span>
    </div>
    <div class="nav-item" id="navHeart" onclick="app.goToFavorites()">
      <span class="nav-icon">â¤ï¸</span>
      <span class="nav-label">ãƒªã‚¹ãƒˆ</span>
    </div>
    <div class="nav-item" id="navChat" onclick="app.goToChatList()">
      <span class="nav-icon">ğŸ’¬</span>
      <span class="nav-label">ãƒˆãƒ¼ã‚¯</span>
    </div>
    <div class="nav-item" id="navMyPage" onclick="app.goToMyPage()">
      <span class="nav-icon">ğŸ‘¤</span>
      <span class="nav-label">ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
    </div>
  </nav>

</div>

<script>
const app = {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
  user: {
    name: "",
    hobby: "",
    role: "requester", // 'requester' (åˆ©ç”¨è€…) or 'supporter' (ä¸€èˆ¬äºº/ãƒ˜ãƒ«ãƒ‘ãƒ¼)
    coin: 1200
  },
  
  chatHistory: {},
  mailbox: [
    {type:'system', title:'ã‚ˆã†ã“ãï¼', body:'Share My Sightã¸ã‚ˆã†ã“ãã€‚', date:'2023/10/01', claimed: true}
  ],
  followed: new Set(),
  currentChatUser: null,
  reviewTarget: null,
  currentRating: 0,
  currentCoin: 0,
  targetList: [],
  lastScreen: 'match',
  toastTimer: null,

  // ãƒ‡ãƒ¼ã‚¿
  supporters: [
    {name:"Aã•ã‚“", age:"20ä»£", location:"é³¥å–é§…è¿‘è¾º", hobbies:["ã‚²ãƒ¼ãƒ ","éŸ³æ¥½"], icon: "ğŸ®", skill:"åŒè¡Œæ´è­·ãƒ»ä»£èª­", desc:"ä¼‘æ—¥ã¯ã‚²ãƒ¼ãƒ ãŒå¥½ãã§ã™ã€‚ãŠè²·ã„ç‰©ã‚„æ•£æ­©ã®åŒè¡Œæ´è­·ãŒå¾—æ„ã§ã™ã€‚"},
    {name:"Bã•ã‚“", age:"30ä»£", location:"å¤§é˜ªé§…å‘¨è¾º", hobbies:["æ—…è¡Œ","ã‚«ãƒ•ã‚§"], icon: "â˜•", skill:"ã‚¬ã‚¤ãƒ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼", desc:"ã‚«ãƒ•ã‚§å·¡ã‚ŠãŒè¶£å‘³ã§ã™ã€‚åˆã‚ã¦ã®å ´æ‰€ã¸ã®ãŠå‡ºã‹ã‘ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚"},
    {name:"Cã•ã‚“", age:"20ä»£", location:"æ±äº¬é§…ä»˜è¿‘", hobbies:["é‹å‹•","æ–™ç†"], icon: "ğŸ³", skill:"ä»£ç­†ãƒ»ä»£èª­", desc:"æ–™ç†ã¨é‹å‹•ãŒå¥½ãã§ã™ã€‚æ›¸é¡ã®èª­ã¿ä¸Šã’ã‚„ä»£ç­†ãªã©ã€ç´°ã‹ã„ä½œæ¥­ã‚‚ãŠä»»ã›ãã ã•ã„ã€‚"},
    {name:"Dã•ã‚“", age:"20ä»£", location:"åå¤å±‹é§…å‘¨è¾º", hobbies:["éŸ³æ¥½","æ˜ ç”»"], icon: "ğŸµ", skill:"åŒè¡Œæ´è­·", desc:"éŸ³æ¥½é‘‘è³ãŒè¶£å‘³ã§ã™ã€‚ãƒ©ã‚¤ãƒ–ã‚„æ˜ ç”»é¤¨ã¸ã®åŒè¡Œã‚‚ãŠæ‰‹ä¼ã„ã§ãã¾ã™ã€‚"},
    {name:"Eã•ã‚“", age:"30ä»£", location:"åšå¤šé§…è¿‘ã", hobbies:["æ•£æ­©","å†™çœŸ"], icon: "ğŸ“·", skill:"ã‚¬ã‚¤ãƒ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼", desc:"å†™çœŸã‚’æ’®ã‚ŠãªãŒã‚‰ã®æ•£æ­©ãŒå¥½ãã§ã™ã€‚ã‚†ã£ãã‚Šãƒšãƒ¼ã‚¹ã§ã®ç§»å‹•æ”¯æ´ãŒå¾—æ„ã§ã™ã€‚"},
    {name:"Fã•ã‚“", age:"20ä»£", location:"æœ­å¹Œé§…å‘¨è¾º", hobbies:["ã‚²ãƒ¼ãƒ ","ã‚«ãƒ•ã‚§"], icon: "ğŸ‘¾", skill:"ã‚¹ãƒãƒ›æ“ä½œè£œåŠ©", desc:"ã‚«ãƒ•ã‚§ã§ã®ã‚“ã³ã‚Šã™ã‚‹ã®ãŒå¥½ãã§ã™ã€‚ã‚¹ãƒãƒ›ã®éŸ³å£°èª­ã¿ä¸Šã’è¨­å®šãªã©ã‚‚ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚"},
    {name:"Gã•ã‚“", age:"30ä»£", location:"ä»™å°é§…å‘¨è¾º", hobbies:["æ—…è¡Œ","éŸ³æ¥½"], icon: "ğŸ¸", skill:"åŒè¡Œæ´è­·", desc:"æ—…è¡ŒãŒå¥½ãã§è‰²ã€…ãªå ´æ‰€ã«è¡Œãã¾ã™ã€‚å®‰å…¨ã«æ¥½ã—ãç§»å‹•ã§ãã‚‹ã‚ˆã†ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚"},
    {name:"Hã•ã‚“", age:"20ä»£", location:"æ¨ªæµœé§…è¿‘ã", hobbies:["æ˜ ç”»","æ–™ç†"], icon: "ğŸ¬", skill:"è²·ã„ç‰©åŒè¡Œ", desc:"æ–™ç†ãŒå¥½ããªã®ã§ã€ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§ã®é£Ÿæé¸ã³ã®ãŠæ‰‹ä¼ã„ã¯ãŠä»»ã›ãã ã•ã„ã€‚"}
  ],
  requesters: [
    {name:"ä½è—¤ã•ã‚“", age:"40ä»£", location:"é³¥å–ç ‚ä¸˜å‘¨è¾º", hobbies:["æ•£æ­©"], icon: "ğŸ‘¨â€ğŸ¦¯", skill:"ç§»å‹•æ”¯æ´å¸Œæœ›", desc:"é§…ã¾ã§ã®ç§»å‹•ã«ä¸å®‰ãŒã‚ã‚Šã¾ã™ã€‚åŒè¡Œã‚’ãŠé¡˜ã„ã—ãŸã„ã§ã™ã€‚"},
    {name:"éˆ´æœ¨ã•ã‚“", age:"60ä»£", location:"å¤§é˜ªé§…å‘¨è¾º", hobbies:["æ—…è¡Œ"], icon: "ğŸ‘©â€ğŸ¦¯", skill:"è²·ã„ç‰©åŒè¡Œå¸Œæœ›", desc:"ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§ã®è²·ã„ç‰©ã‚’ãŠæ‰‹ä¼ã„ã—ã¦ã»ã—ã„ã§ã™ã€‚å•†å“ã®è¡¨ç¤ºãŒè¦‹ãˆã«ãã„ã®ã§ã€‚"},
    {name:"é«˜æ©‹ã•ã‚“", age:"20ä»£", location:"æ–°å®¿è¿‘è¾º", hobbies:["éŸ³æ¥½"], icon: "ğŸ§", skill:"ãƒ©ã‚¤ãƒ–åŒè¡Œå¸Œæœ›", desc:"åˆã‚ã¦è¡Œããƒ©ã‚¤ãƒ–ãƒã‚¦ã‚¹ã¾ã§ã®èª˜å°ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚"},
    {name:"ç”°ä¸­ã•ã‚“", age:"50ä»£", location:"åšå¤šé§…è¿‘ã", hobbies:["èª­æ›¸"], icon: "ğŸ“š", skill:"ä»£èª­å¸Œæœ›", desc:"å½¹æ‰€ã‹ã‚‰ã®æ›¸é¡ãŒå±Šã„ãŸã®ã§ã€å†…å®¹ã®èª­ã¿ä¸Šã’ã¨è¨˜å…¥ä»£è¡Œã‚’ãŠé¡˜ã„ã—ãŸã„ã§ã™ã€‚"}
  ],

  // ç”»é¢é·ç§»
  showScreen: function(screenId) {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    const target = document.getElementById(screenId);
    if(target) {
      target.classList.add('active');
      target.scrollTop = 0;
    }

    const navBar = document.getElementById("navBar");
    const headerIcons = document.getElementById("headerIcons");
    const fullScreens = ['welcomeScreen', 'roleScreen', 'hobbyScreen', 'chatRoomScreen', 'reviewScreen', 'mailboxScreen', 'detailScreen'];
    
    if (fullScreens.includes(screenId)) {
      navBar.classList.remove('active');
      headerIcons.classList.add('hidden');
    } else {
      navBar.classList.add('active');
      headerIcons.classList.remove('hidden');
    }
  },
  
  updateNav: function(activeId) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if(activeId) document.getElementById(activeId).classList.add('active');
  },

  // 1. åå‰å…¥åŠ›
  checkNameInput: function() {
    const name = document.getElementById("userNameInput").value.trim();
    const btn = document.getElementById("toHobbyBtn");
    if(name.length > 0) {
      btn.disabled = false;
      btn.style.opacity = 1;
      btn.style.pointerEvents = "auto";
    } else {
      btn.disabled = true;
      btn.style.opacity = 0.6;
      btn.style.pointerEvents = "none";
    }
  },
  goToRoleSelection: function() {
    const name = document.getElementById("userNameInput").value.trim();
    if (!name) return;
    this.user.name = name;
    this.showScreen('roleScreen');
  },

  // 1.5 ãƒ­ãƒ¼ãƒ«é¸æŠ
  selectRole: function(role) {
    this.user.role = role;
    if (role === 'requester') {
      this.targetList = this.supporters;
      document.getElementById("hobbyTitle").textContent = `ã“ã‚“ã«ã¡ã¯ã€${this.user.name}ã•ã‚“ï¼`;
      this.renderHobbyGrid();
      this.showScreen('hobbyScreen');
    } else {
      this.targetList = this.requesters;
      document.getElementById("matchScreenTitle").textContent = "å±Šã„ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆ";
      document.getElementById("matchHeaderText").textContent = "ã‚ãªãŸã®ã‚µãƒãƒ¼ãƒˆã‚’å¾…ã£ã¦ã„ã¾ã™";
      const footer = document.getElementById("matchFooterText");
      if(footer) footer.textContent = "è©³ç´°ã‚’ç¢ºèªã—ã¦æ‰¿èªã—ã¦ãã ã•ã„";
      document.getElementById("favSubTitle").textContent = "æ‰¿èªå¾…ã¡ãƒªã‚¹ãƒˆ";
      this.renderMatches();
      this.showScreen('matchScreen');
      this.updateNav('navSearch');
    }
  },
  backToWelcome: function() { this.showScreen('welcomeScreen'); },
  backToRoleSelection: function() { this.showScreen('roleScreen'); },

  // 2. è¶£å‘³é¸æŠ
  renderHobbyGrid: function() {
    const grid = document.getElementById("hobbyGrid");
    grid.innerHTML = "";
    const allHobbies = new Set();
    this.supporters.forEach(p => p.hobbies.forEach(h => allHobbies.add(h)));
    Array.from(allHobbies).forEach(hobby => {
      const btn = document.createElement("div");
      btn.className = "hobby-choice";
      btn.textContent = hobby;
      btn.onclick = () => this.selectHobby(hobby, btn);
      grid.appendChild(btn);
    });
  },
  selectHobby: function(hobby, btnElement) {
    this.user.hobby = hobby;
    document.querySelectorAll('.hobby-choice').forEach(el => el.classList.remove('selected'));
    btnElement.classList.add('selected');
    document.getElementById("toMatchBtn").disabled = false;
  },

  // 3. ãƒãƒƒãƒãƒ³ã‚°
  goToMatchScreen: function() {
    this.renderMatches();
    this.showScreen('matchScreen');
    this.updateNav('navSearch');
  },
  renderMatches: function() {
    const grid = document.getElementById("matchGrid");
    grid.innerHTML = "";
    let list = this.targetList;
    
    if (this.user.role === 'requester') {
      const userHobby = this.user.hobby;
      document.getElementById("matchHeaderText").textContent = `ã€Œ${userHobby}ã€ã«é–¢å¿ƒãŒã‚ã‚‹ã‚µãƒãƒ¼ã‚¿ãƒ¼`;
      list = [...this.targetList].sort((a,b) => {
        const aM = a.hobbies.includes(userHobby);
        const bM = b.hobbies.includes(userHobby);
        return bM - aM;
      });
    }

    list.forEach(p => {
      const isMatch = this.user.role === 'requester' && p.hobbies.includes(this.user.hobby);
      const card = document.createElement("div");
      card.className = `match-card ${isMatch ? 'best-match' : ''}`;
      
      let badgeHtml = isMatch ? `<div class="match-badge">è©±é¡ŒãŒåˆã„ã¾ã™ï¼</div>` : '';
      if(this.user.role === 'supporter') badgeHtml = `<div class="match-badge">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>`;
      
      const color = this.user.role === 'supporter' ? '#ff6b81' : '#0066cc';

      card.innerHTML = `
        ${badgeHtml}
        <div class="card-img-placeholder">${p.icon}</div>
        <h2>${p.name} <span style="font-size:16px; color:#666;">(${p.age})</span></h2>
        <p style="color:${color}; font-weight:bold; margin:4px 0;">${p.skill}</p>
        <p style="color:#666; font-size:14px;">ğŸ“ ${p.location}</p>
        <div class="tag">${p.hobbies[0]}</div>
      `;
      card.onclick = () => this.showDetail(p);
      grid.appendChild(card);
    });
  },

  // 4. ãŠæ°—ã«å…¥ã‚Š
  goToFavorites: function() {
    this.renderFavorites();
    this.showScreen('favoriteScreen');
    this.updateNav('navHeart');
  },
  renderFavorites: function() {
    const grid = document.getElementById("favoriteGrid");
    grid.innerHTML = "";
    const list = this.targetList.filter(p => this.followed.has(p.name));
    
    if (list.length === 0) {
      grid.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">ãƒªã‚¹ãƒˆã¯ç©ºã§ã™</div>`;
      return;
    }
    
    const color = this.user.role === 'supporter' ? '#ff6b81' : '#0066cc';
    list.forEach(p => {
      const card = document.createElement("div");
      card.className = "match-card";
      card.innerHTML = `
        <div style="display:flex; align-items:center; width:100%; text-align:left;">
          <div style="font-size:30px; margin-right:16px; background:#cce7ff; width:50px; height:50px; display:flex; align-items:center; justify-content:center; border-radius:50%;">${p.icon}</div>
          <div style="flex:1;">
            <div style="font-weight:bold;">${p.name}</div>
            <div style="font-size:12px; color:${color}; font-weight:bold;">${p.skill}</div>
          </div>
          <div style="font-size:20px; color:#ccc;">â€º</div>
        </div>
      `;
      card.onclick = () => this.showDetail(p);
      grid.appendChild(card);
    });
  },

  // 5. ãƒãƒ£ãƒƒãƒˆä¸€è¦§
  goToChatList: function() {
    this.renderChatList();
    this.showScreen('chatListScreen');
    this.updateNav('navChat');
  },
  renderChatList: function() {
    const container = document.getElementById("chatListContainer");
    container.innerHTML = "";
    const list = this.targetList.filter(p => this.followed.has(p.name));
    
    if (list.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }
    
    list.forEach(p => {
      const item = document.createElement("div");
      item.className = "chat-list-item";
      item.onclick = () => this.openChat(p);
      item.innerHTML = `
        <div class="chat-list-icon">${p.icon}</div>
        <div class="chat-list-content">
          <div class="chat-list-name">${p.name}</div>
          <div class="chat-list-msg">ã“ã‚“ã«ã¡ã¯ï¼</div>
        </div>
        <div style="font-size:12px; color:#999;">Now</div>
      `;
      container.appendChild(item);
    });
  },

  // 6. ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ 
  openChat: function(p) {
    this.currentChatUser = p;
    document.getElementById("chatTargetName").textContent = p.name;
    this.showScreen('chatRoomScreen');
    
    const completeBtn = document.getElementById("completeBtn");
    if (this.user.role === 'supporter') {
      completeBtn.style.display = 'none';
      setTimeout(() => { this.receiveRewardSimulation(p.name); }, 5000);
    } else {
      completeBtn.style.display = 'flex';
    }

    const area = document.getElementById("chatMessageArea");
    area.innerHTML = "";
    
    if (!this.chatHistory[p.name]) {
      let initMsg = "";
      if (this.user.role === 'requester') {
        initMsg = `ã“ã‚“ã«ã¡ã¯ï¼ãƒãƒƒãƒãƒ³ã‚°ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n${p.skill}ãŒå¯èƒ½ã§ã™ã€‚ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ`;
      } else {
        initMsg = `ã“ã‚“ã«ã¡ã¯ï¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ‰¿èªã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nã€Œ${p.skill}ã€ã‚’ãŠé¡˜ã„ã—ãŸã„ã®ã§ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ`;
      }
      this.chatHistory[p.name] = [
        { type: 'system', html: `<div style="text-align:center; color:#999; font-size:12px; margin-bottom:10px;">${p.name}ã•ã‚“ã¨ã¤ãªãŒã‚Šã¾ã—ãŸ</div>` },
        { type: 'received', text: initMsg }
      ];
    }
    
    this.chatHistory[p.name].forEach(msg => this.renderMessage(msg, area));
    setTimeout(() => { area.scrollTop = area.scrollHeight; }, 100);
  },

  renderMessage: function(msg, container) {
    const div = document.createElement('div');
    if (msg.type === 'system') {
      div.innerHTML = msg.html;
    } else {
      div.className = msg.type === 'sent' ? "message-bubble msg-sent" : "message-bubble msg-received";
      if(msg.html) div.innerHTML = msg.html;
      else div.innerText = msg.text;
    }
    container.appendChild(div);
  },

  sendMessage: function() {
    const input = document.getElementById("chatInput");
    const text = input.value.trim();
    if (!text) return;
    const targetName = this.currentChatUser.name;
    const area = document.getElementById("chatMessageArea");
    const msgData = { type: 'sent', text: text };
    if(!this.chatHistory[targetName]) this.chatHistory[targetName] = [];
    this.chatHistory[targetName].push(msgData);
    this.renderMessage(msgData, area);
    input.value = "";
    area.scrollTop = area.scrollHeight;
    
    setTimeout(() => {
      const reply = { type: 'received', text: "äº†è§£ã—ã¾ã—ãŸï¼" };
      this.chatHistory[targetName].push(reply);
      if(this.currentChatUser && this.currentChatUser.name === targetName) {
        this.renderMessage(reply, area);
        area.scrollTop = area.scrollHeight;
      }
    }, 1000);
  },
  
  backToChatList: function() {
    this.currentChatUser = null;
    this.goToChatList();
  },

  openPlanModal: function() {
    document.getElementById("planModal").classList.add("open");
  },
  closePlanModal: function() {
    document.getElementById("planModal").classList.remove("open");
  },
  submitPlan: function() {
    const date = document.getElementById("planDate").value;
    const place = document.getElementById("planPlace").value;
    const todo = document.getElementById("planTodo").value;
    if(!date || !place || !todo) { this.showToast("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    
    const targetName = this.currentChatUser.name;
    const area = document.getElementById("chatMessageArea");
    const html = `
      <div class="plan-card">
        <div class="plan-header">ğŸ“… ææ¡ˆ</div>
        <div class="plan-body">
          <div><b>æ—¥æ™‚:</b> ${date}</div>
          <div><b>å ´æ‰€:</b> ${place}</div>
          <div><b>å†…å®¹:</b> ${todo}</div>
        </div>
      </div>
    `;
    const msg = { type: 'sent', html: html };
    if(!this.chatHistory[targetName]) this.chatHistory[targetName] = [];
    this.chatHistory[targetName].push(msg);
    this.renderMessage(msg, area);
    this.closePlanModal();
    area.scrollTop = area.scrollHeight;
  },

  // ===== (å¾©å…ƒ) ãƒªãƒƒãƒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°è¡¨ç¤º =====
  showDetail: function(p) {
    this.showScreen('detailScreen');
    
    // ãƒ­ãƒ¼ãƒ«ã”ã¨ã®è‰²è¨­å®š
    const skillColor = this.user.role === 'requester' ? '#0066cc' : '#ff6b81';
    
    // ãƒãƒƒãƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    let matchMsg = '';
    if (this.user.role === 'requester' && p.hobbies.includes(this.user.hobby)) {
      matchMsg = `<div style="text-align:center; color:#0066cc; font-weight:bold; margin-bottom:16px;">âœ¨ ${this.user.hobby}ã®è©±ã§ç››ã‚Šä¸ŠãŒã‚Œã¾ã™ï¼</div>`;
    }

    const isFollowed = this.followed.has(p.name);
    const btnClass = isFollowed ? 'action-main-btn btn-connected' : 'action-main-btn btn-connect';
    let btnText = isFollowed ? 'âœ” æ¥ç¶šä¸­ï¼ˆãƒãƒ£ãƒƒãƒˆå¯èƒ½ï¼‰' : (this.user.role === 'requester' ? 'ï¼‹ ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ç›¸è«‡ã™ã‚‹' : 'ï¼‹ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èªã™ã‚‹');
    
    // HTMLæ§‹ç¯‰ (å¾©å…ƒã—ãŸãƒªãƒƒãƒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ)
    const html = `
      <button class="detail-back-overlay" onclick="app.goBackFromDetail()">â€¹</button>
      <div class="profile-cover">
        <div class="profile-avatar-wrapper">${p.icon}</div>
      </div>
      
      <div class="profile-info-area">
        <div class="profile-main-name">${p.name} <span style="font-size:18px; font-weight:normal; color:#666;">(${p.age})</span></div>
        <div class="profile-meta-row">
          <span>ğŸ“ ${p.location}</span>
        </div>
        
        ${matchMsg}

        <div class="profile-stats-card">
          <div class="stat-item">
            <div class="stat-val">4.9</div>
            <div class="stat-label">è©•ä¾¡</div>
          </div>
          <div class="stat-item">
            <div class="stat-val">12</div>
            <div class="stat-label">ã‚µãƒãƒ¼ãƒˆæ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-val" style="color:${skillColor};">${p.skill}</div>
            <div class="stat-label">ã‚¿ã‚¤ãƒ—</div>
          </div>
        </div>

        <div class="content-section">
          <div class="section-label">èˆˆå‘³ãƒ»é–¢å¿ƒ</div>
          <div class="tags-wrapper">
            ${p.hobbies.map(h => `<span class="hobby-tag">${h}</span>`).join('')}
          </div>
        </div>

        <div class="content-section">
          <div class="section-label">è‡ªå·±ç´¹ä»‹</div>
          <div class="bio-text">${p.desc}</div>
        </div>
      </div>

      <div class="profile-fixed-footer">
        <button id="followBtn" class="${btnClass}" onclick="app.toggleFollow('${p.name}')">${btnText}</button>
      </div>
    `;
    
    document.getElementById("detailContent").innerHTML = html;
  },
  
  goBackFromDetail: function() {
    if (this.lastScreen === 'favorite') this.goToFavorites();
    else if (this.lastScreen === 'chatList') this.goToChatList();
    else if (this.lastScreen === 'shop') this.goToShop();
    else if (this.lastScreen === 'mypage') this.goToMyPage();
    else this.goToMatchScreen();
  },

  toggleFollow: function(targetName) {
    const btn = document.getElementById("followBtn");
    if (this.followed.has(targetName)) {
      this.followed.delete(targetName);
      btn.classList.remove('btn-connected');
      btn.classList.add('btn-connect');
      const btnText = this.user.role === 'requester' ? 'ï¼‹ ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ç›¸è«‡ã™ã‚‹' : 'ï¼‹ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èªã™ã‚‹';
      btn.innerHTML = btnText;
      this.showToast(`ã€Œ${targetName}ã€ã•ã‚“ã¨ã®æ¥ç¶šã‚’è§£é™¤ã—ã¾ã—ãŸ`);
    } else {
      this.followed.add(targetName);
      btn.classList.remove('btn-connect');
      btn.classList.add('btn-connected');
      btn.innerHTML = "âœ” æ¥ç¶šä¸­ï¼ˆãƒãƒ£ãƒƒãƒˆå¯èƒ½ï¼‰";
      this.showToast("æ¥ç¶šã—ã¾ã—ãŸï¼ãƒãƒ£ãƒƒãƒˆå¯èƒ½ã§ã™");
    }
  },

  // è©•ä¾¡ãƒ»ã‚³ã‚¤ãƒ³ãƒ»ãƒ¡ãƒ¼ãƒ«
  receiveRewardSimulation: function(senderName) {
    if (this.user.role !== 'supporter') return;
    const exists = this.mailbox.some(m => m.title.includes(senderName));
    if(exists) return;
    
    this.showToast("æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™ï¼");
    document.getElementById("mailBadge").classList.remove("hidden");
    this.mailbox.unshift({
      type: 'reward',
      title: 'è©•ä¾¡å®Œäº†',
      body: `${senderName}ã•ã‚“ã‹ã‚‰è©•ä¾¡ãŒå±Šãã¾ã—ãŸã€‚\nã‚¿ãƒƒãƒ—ã—ã¦500ã‚³ã‚¤ãƒ³ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ã€‚`,
      coin: 500,
      date: new Date().toLocaleDateString(),
      claimed: false
    });
  },

  openReview: function() {
    this.showScreen('reviewScreen');
    document.getElementById("reviewTargetName").textContent = this.currentChatUser.name + "ã•ã‚“";
    document.getElementById("reviewTargetIcon").textContent = this.currentChatUser.icon;
    this.currentCoin = 0;
    this.setCoin(0);
  },
  setRating: function(r) {
    document.querySelectorAll('.star').forEach((s,i) => s.className = i < r ? 'star active' : 'star');
  },
  setCoin: function(n) {
    this.currentCoin = n;
    document.querySelectorAll('.coin-btn').forEach(b => {
      if((n===0 && b.textContent==="ãªã—") || b.textContent==n) b.classList.add('active');
      else b.classList.remove('active');
    });
    document.getElementById("coinAmountDisplay").textContent = n + " æš";
  },
  cancelReview: function() { this.showScreen('chatRoomScreen'); },
  submitReview: function() {
    if(this.currentCoin > 0) {
      if(this.user.coin < this.currentCoin) { this.showToast("ã‚³ã‚¤ãƒ³ä¸è¶³ã§ã™"); return; }
      this.user.coin -= this.currentCoin;
    }
    this.showToast("è©•ä¾¡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
    const name = this.currentChatUser.name;
    delete this.chatHistory[name];
    this.followed.delete(name);
    setTimeout(() => this.goToMatchScreen(), 1500);
  },

  openMailbox: function() {
    this.showScreen('mailboxScreen');
    document.getElementById("mailBadge").classList.add("hidden");
    const list = document.getElementById("mailboxList");
    list.innerHTML = "";
    this.mailbox.forEach((m, idx) => {
      const div = document.createElement("div");
      div.className = "mail-item";
      let statusHtml = "";
      if(m.type === 'reward') {
        if(m.claimed) {
          div.style.background = "#f9f9f9";
          statusHtml = `<div style="font-size:12px; color:#999;">å—å–æ¸ˆã¿</div>`;
        } else {
          div.style.background = "#fff9e6";
          div.style.border = "2px solid #ffd700";
          statusHtml = `<div style="font-size:12px; color:#e6ac00; font-weight:bold;">ã‚¿ãƒƒãƒ—ã—ã¦å—å–</div>`;
          div.onclick = () => {
            this.user.coin += m.coin;
            m.claimed = true;
            this.showToast(`${m.coin}ã‚³ã‚¤ãƒ³ç²å¾—ï¼`);
            this.openMailbox();
          };
        }
      }
      div.innerHTML = `
        <div class="mail-icon">${m.type==='reward' ? 'ğŸ' : 'ğŸ“¢'}</div>
        <div class="mail-content">
          <div class="mail-title">${m.title}</div>
          <div class="mail-body">${m.body.replace(/\n/g, '<br>')}</div>
          ${statusHtml}
          <div class="mail-time">${m.date}</div>
        </div>
      `;
      list.appendChild(div);
    });
  },
  closeMailbox: function() { this.goToMatchScreen(); },

  goToShop: function() {
    this.showScreen('shopScreen');
    this.updateNav('navShop');
    document.getElementById("shopCoinDisplay").textContent = this.user.coin.toLocaleString();
  },
  exchangeItem: function(cost, name) {
    if(this.user.coin >= cost) {
      this.user.coin -= cost;
      this.goToShop();
      this.showToast(`${name}ã¨äº¤æ›ã—ã¾ã—ãŸ`);
    } else {
      this.showToast("ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“");
    }
  },

  goToMyPage: function() {
    this.showScreen('myPageScreen');
    this.updateNav('navMyPage');
    document.getElementById("myPageName").textContent = this.user.name || "ã‚²ã‚¹ãƒˆ";
    document.getElementById("myPageRole").textContent = this.user.role === 'requester' ? "åˆ©ç”¨è€…" : "ã‚µãƒãƒ¼ã‚¿ãƒ¼";
    document.getElementById("myPageCoin").textContent = this.user.coin.toLocaleString();
    document.getElementById("myPageHobby").textContent = this.user.hobby || "æœªè¨­å®š";
  },

  showToast: function(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    if(this.toastTimer) clearTimeout(this.toastTimer);
    this.toastTimer = setTimeout(() => t.classList.remove("show"), 3000);
  }
};

window.onload = function() {
  app.checkNameInput();
  app.showScreen('welcomeScreen'); 
};
</script>
</body>
</html>
